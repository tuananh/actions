# Copyright 2022 Tuan Anh Tran <me@tuananh.org>

name: gen-key
description: |
  This action generate Trivy scan result badge.
inputs:
  image:
    description: |
      image used for scanning
    required: true

runs:
  using: "composite"
  steps:
    - id: trivy-template
      shell: bash
      run: |
        wget https://raw.githubusercontent.com/tuananh/actions/main/gen-trivy-badge/template.txt
        cat template.txt
        OUTPUT_TEMPLATE=$(cat template.txt)
        OUTPUT_TEMPLATE="${OUTPUT_TEMPLATE//'%'/'%25'}"
        OUTPUT_TEMPLATE="${OUTPUT_TEMPLATE//$'\n'/'%0A'}"
        OUTPUT_TEMPLATE="${OUTPUT_TEMPLATE//$'\r'/'%0D'}"
        echo "template=$OUTPUT_TEMPLATE" >> $GITHUB_OUTPUT
    - shell: bash
      run: |
        echo ${{ steps.trivy-template.outputs.template }}
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ inputs.image }}
        format: 'template'
        template: ${{ steps.trivy-template.outputs.template }}
        output: 'trivy_scan_result.yaml'
    - name: Debug
      shell: bash
      run: |
        cat trivy_scan_result.yaml